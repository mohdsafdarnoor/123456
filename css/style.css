// ============================================================
// HS WISMAR - AI JOB SEARCH SUPPORT
// Main JavaScript File
// ============================================================

(function () {
  'use strict';

  // 1. CLICK & INTERACTION FIX (CRITICAL)
  function enablePageInteractions() {
    document.documentElement.style.pointerEvents = "auto";
    document.body.style.pointerEvents = "auto";

    // Hide any blocking overlays
    const blockers = [
      ".overlay", ".loader", ".loading", ".backdrop", 
      ".modal-backdrop", "#overlay", "#loading"
    ];

    blockers.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => {
        el.style.display = "none";
        el.style.pointerEvents = "none";
      });
    });
  }
  document.addEventListener("DOMContentLoaded", enablePageInteractions);
  window.addEventListener("load", enablePageInteractions);


  // 2. MOBILE HAMBURGER MENU
  function initMobileMenu() {
    const hamburger = document.querySelector(".hamburger");
    const mobileNav = document.querySelector(".mobile-nav");

    if (hamburger && mobileNav) {
      hamburger.addEventListener("click", () => {
        mobileNav.classList.toggle("active");
        
        // Toggle icon between Menu (☰) and Close (✕)
        if (mobileNav.classList.contains("active")) {
          hamburger.textContent = "✕";
        } else {
          hamburger.textContent = "☰";
        }
      });

      // Close menu when clicking a link
      mobileNav.querySelectorAll("a").forEach(link => {
        link.addEventListener("click", () => {
          mobileNav.classList.remove("active");
          hamburger.textContent = "☰";
        });
      });
    }
  }
  document.addEventListener("DOMContentLoaded", initMobileMenu);


  // 3. ACCORDION (One-Open-Logic)
  function initAccordions() {
    const headers = document.querySelectorAll(".accordion-header");
    headers.forEach(header => {
      // Remove old listeners to prevent duplicates
      header.removeEventListener("click", toggleAccordion);
      header.addEventListener("click", toggleAccordion);
    });
  }

  function toggleAccordion(e) {
    const header = e.currentTarget;
    const content = header.nextElementSibling;
    const parent = header.closest(".card");
    
    // Close others in same card
    if (parent) {
      parent.querySelectorAll(".accordion-content").forEach(c => {
        if (c !== content) c.classList.remove("active");
      });
      parent.querySelectorAll(".accordion-header").forEach(h => {
        if (h !== header) h.classList.remove("active");
      });
    }

    // Toggle current
    header.classList.toggle("active");
    content.classList.toggle("active");
  }
  document.addEventListener("DOMContentLoaded", initAccordions);


  // 4. ACTIVE NAV LINK
  function highlightActiveLink() {
    const path = window.location.pathname.split("/").pop() || "index.html";
    document.querySelectorAll(".nav-link").forEach(link => {
      // Clean up href (remove ./ and query params)
      const href = link.getAttribute("href").split("?")[0].replace("./", "");
      
      link.classList.remove("active");
      if (href === path || (path === "" && href === "index.html")) {
        link.classList.add("active");
      }
    });
  }
  document.addEventListener("DOMContentLoaded", highlightActiveLink);


  // 5. CONTACT FORM HANDLER (Web3Forms)
  function initContactForm() {
    const form = document.querySelector("form[action*='web3forms']");
    if (form) {
      form.addEventListener("submit", async function(e) {
        e.preventDefault();
        const btn = form.querySelector("button[type='submit']");
        const originalText = btn.textContent;
        
        btn.textContent = "Sending...";
        btn.disabled = true;

        try {
          const response = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { "Accept": "application/json" }
          });
          
          if (response.ok) {
            alert("✅ Message Sent Successfully!");
            form.reset();
          } else {
            throw new Error("Failed to send");
          }
        } catch (error) {
          alert("❌ Error sending message. Please try again.");
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      });
    }
  }
  document.addEventListener("DOMContentLoaded", initContactForm);


  // 6. SMOOTH SCROLL
  function initSmoothScroll() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        const targetId = this.getAttribute("href");
        if (targetId === "#") return;
        
        const target = document.querySelector(targetId);
        if (target) {
          e.preventDefault();
          // Scroll with offset for header
          const offset = 100; 
          const elementPosition = target.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;
  
          window.scrollTo({
            top: offsetPosition,
            behavior: "smooth"
          });
          
          // Open accordion if target is inside one
          const parentContent = target.closest(".accordion-content");
          if (parentContent) {
            parentContent.classList.add("active");
            parentContent.previousElementSibling.classList.add("active");
          }
        }
      });
    });
  }
  document.addEventListener("DOMContentLoaded", initSmoothScroll);


  // 7. EXTERNAL LINK SECURITY
  function secureExternalLinks() {
    document.querySelectorAll('a[target="_blank"]').forEach(link => {
      link.setAttribute("rel", "noopener noreferrer");
    });
  }
  document.addEventListener("DOMContentLoaded", secureExternalLinks);

})();
